<html>
<head>
<link rel="stylesheet" type="text/css" href="/css/app.css">
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/bower_components/moment/moment.js"></script>
<script type="text/javascript" src="/SyncNode.js"></script>
<script type="text/javascript" src="/SyncNodeSocket.js"></script>
<script type="text/javascript" src="/SyncView.js"></script>
<script type="text/javascript" src="/parse.js"></script>
<link rel="import" id="components.html" href="/components.html">
</head>
<body>


<script id="view" type="text/other">

#hub:EventHub
#header:Header
#ticketList:TicketList
#ticketDetails:TicketDetails[col]
#orderItemDetails:OrderItemDetails[col]
#menuItems:MenuItems[col right]
#menuCategories:MenuCategories[col right]


EventHub

LabeledValue[label-set]
	#label[label]
	#value[value]
	#init:function(options)
		this.label.innerHTML = options.label;



TableSelect[col col-flex]
	#list[col-fill list]
	#init:function
		var tables = ['1-1', '1-2', '1-3', '1-4', '1-5', '1-6', '2-1', '2-2', '2-3', '2-4', 'Bar', 'Deck', 'Other'];
		tables.forEach((table) => {
			var item = buildComponent('Table');
			item.update({ name: table });
			this.list.appendChild(item.node);
		});

Table[item]
	#nameSpan$(data.name)


RecTotalsEdit
	#beginning:Input({ label: 'Beginning', prop: 'beginning', number: true })$(update=data)[number]
	#sales:LabeledValue({ label: 'Sales' })[number]
	#ending:Input({ label: 'Ending', prop: 'ending', number: true })$(update=data)[number]
	#credit:Input({ label: 'Credit, no tips', prop: 'Credit', number: true })$(update=data)[number]
	#creditTips:Input({ label: 'Credit Tips', prop: 'Credit Tips', number: true })$(update=data)[number]
	#giftCards:Input({ label: 'Gift Cards', prop: 'giftCards', number: true })$(update=data)[number]
	#payouts:Input({ label: 'Payouts', prop: 'Payouts', number: true })$(update=data)[number]
	#total:LabeledValue({ label: 'Total' })[number]
		style:
			font-weight: bold;
			font-size: 24px;
	#render:function
		this.total.value.innerHTML = SV.formatCurrency(this.data.beginning);
		this.sales.value.innerHTML = SV.formatCurrency(this.data.parent.totals.total);



RecSettings
	:h1 'Rec Settings'
	#totals:RecTotalsEdit
		style:
			width: 50%;
			float: left;
	#close[btn] 'Close'
		events:
			click:
				this.emit('close');
	#render:function
		this.totals.update(this.data)

RecTotals[header]
	:style
		margin-right: 16px;
	#total:div
		style:
			float: right;
	#render:function
		this.total.innerHTML = SV.formatCurrency(this.data.total);

Header[row dark]
	:style
		height: 56px;
		border-bottom: 1px solid #000;
	:div[row-nofill touch material-icons row-right] 'settings'
		events:
			click:
				this.recSettingsModal.show();
	#totals:RecTotals[row-right]
	#userSelect:Select({ prop: 'data.info.name' })[row-nofill]
		style:
			width: 239px;
		events:
			selected(name):
				window.recSettings.set('currentUser', name);
	#init:function
		this.recSettings = buildComponent('RecSettings');
		this.recSettingsModal = Modal.createModal(this.recSettings);
		hub.on('ticketTotalsChanged', () => { 
			var totals = RecUtils.getRecTotals(this.data);
			this.data.merge({ totals: totals });
		});
	#render:function
		this.totals.update(this.data.totals);
		this.recSettings.update(this.data.drawer);
		

TicketList[col col-flex col-left]
	#list:SearchList({ text: 'Tickets', ctor: 'Ticket', searchBox: true, sort: 'name', searchProp: 'name', addBtn: true })[col-fill]
		events:
			selected(item): 
				ticketDetails.update(item);
			add(value):
				this.list.clearSearch();
				this.add(value);
				
	#add:function(name)
		var name = name || '';
		name = name.trim();
		if(!name) return;
		var newItem = { 
			key: SyncNode.guidShort(), 
			addedAt: new Date().toISOString(),
			addedBy: window.recSettings.currentUser,
			servedBy: window.recSettings.currentUser,
			name: name,
			table: '',
			orderItems: {},
			paymentStatus: 'Unpaid',
			totals: { food: 0, tax: 0, alcohol: 0, total: 0 }
		};
		console.log('date', new Date(), new Date().toISOString());
		var result = this.data.set(newItem.key, newItem)[newItem.key];
		this.list.select(result.key);
	#init:function
		this.tableSelect = buildComponent('TableSelect');
		this.tableSelectModal = Modal.createModal(this.tableSelect);
	#render:function 
		this.list.update(this.data);
		ticketDetails.update(this.list.selected);
		if(this.test) return;
		this.test = true;
		this.list.select(SV.toArray(this.data)[0].key);
		this.tableSelectModal.show();

Ticket[item tight]
	#total[right]
	#nameSpan$(data.name)
	#lastOrderTime[italic margin1]
		style:
			color: rgba(0,0,0,0.5);
	#updateLastOrderTime:function
		var lastOrderItem;
		SV.toArray(this.data.orderItems).forEach((orderItem) => {
			if(!lastOrderItem || orderItem.addedAt > lastOrderItem.addedAt) {
				lastOrderItem = orderItem;
			}
		});
		this.lastOrderTime.innerHTML = lastOrderItem ? moment(lastOrderItem.addedAt).from(moment()) : 'no orders';
	#init:function
		this.node.addEventListener('click', 
			() => { this.emit('selected', this.data); });
	#render:function
		this.total.innerHTML = SV.formatCurrency(this.data.totals.total);
		if(!this.lastOrderTimeTimer) {
			this.updateLastOrderTime();
			this.lastOrderTimeTimer = setInterval(() => { this.updateLastOrderTime(); }, 30000);
		}


TicketTotals[header]
	:style
		border-top: 1px solid rgba(0,0,0,0.5);
		font-size: 24px;
	#total:div
		style:
			float: right;
	#render:function
		this.total.innerHTML = SV.formatCurrency(this.data.totals.total);

TicketDetails[col col-flex wide]
	#header:SimpleHeader({ text: 'Ticket Details', more: true, close: true, del: true})[light border-bottom]
		events:
			more:
				this.showMore = !this.showMore;
				this.render();
			close:
				this.close();
			delete:
				Modal.confirm('Delete?', this.data.name, () => {
					this.data.parent.remove(this.data.key);
					this.close();
				});
	#details:TicketDetailsMore[col-nofill]
	#moreEdit:TicketDetailsMoreEdit[col-nofill light]
	#items:OrderItemList[col-fill]
	#totals:TicketTotals[col-nofill]
	#close:function
			orderItemDetails.close();
			this.update(null);
	#add:function(menuItem)
		if(!ticketDetails.data) {
			console.log('no ticket selected');
			return;
		}
		var newItem = { 
			key: SyncNode.guidShort(),
			addedAt: new Date().toISOString(),
			addedBy: window.recSettings.currentUser,
			servedBy: window.recSettings.currentUser,
			name: menuItem.name,
			price: menuItem.price,
			quantity: 1,
			taxType: menuItem.taxType,
			note: menuItem.note || '' 
		};
		var result = ticketDetails.data.orderItems.set(newItem.key, newItem)[newItem.key];
		ticketDetails.items.list.select(result.key);
		hub.emit('ticketTotalsChanged', this.data);
	#init:function
			this.render();
			hub.on('ticketTotalsChanged', (ticket) => {
				ticket.merge({ totals: RecUtils.getTicketTotals(ticket) });
			});
	#render:function
			this.node.style.display = this.data ? 'flex' : 'none';
			this.details.node.style.display = this.showMore ? 'none' : 'block';
			this.moreEdit.node.style.display = this.showMore ? 'block' : 'none';
			if(this.data) { 
				console.log('hereeeee');
				this.header.text.innerHTML = this.data.name;
				this.items.update(this.data.orderItems);
				this.details.update(this.data);
				this.moreEdit.update(this.data);
				this.moreEdit.server.select(this.data.servedBy);
				this.totals.update(this.data);
			}


TicketDetailsMore
	:style
		color: rgba(0,0,0,0.7);
		border-bottom: 1px solid rgba(0,0,0,0.5);
	#addedAt[row tight right margin1]
	#addedBy[row tight margin1]
	#server[row tight margin1]
	#note$(data.note)[row tight margin2 italic whitespace-pre]
	#updateTime:function
		console.log('addedAt', this.data.addedAt);
		this.addedBy.innerHTML = 'Added by ' + this.data.servedBy + ' ' + moment(this.data.addedAt).from(moment());
	#init:function
	#render:function
		console.log('data', this.data);
		this.server.innerHTML = 'Served by ' + this.data.servedBy;
		this.addedAt.innerHTML = moment(this.data.addedAt).format('h:mma');
		this.note.style.display = this.data.note ? 'flex' : 'none';
		this.updateTime();
		if(!this.timer) {
			this.timer = setInterval(() => { this.updateTime(); }, 30000);
		}

TicketDetailsMoreEdit
	#nameInput:Input({ label: 'Name', prop: 'name'  })$(update=data)
	#noteInput:Input({ label: 'Note', prop: 'note', isTextArea: true })$(update=data)
	#togo:ToggleButton({ prop: 'isTogo', trueText: '**** TOGO ****', falseText: 'Eat In' })$(update=data)
	#server:Select({ label: 'Server', prop: 'data.info.name' })
		events:
			selected(value):
				this.data.set('servedBy', value); 	


OrderItemList[col-flex]
	#list:SearchList({ text: 'Order Items', ctor: 'OrderItem' })[col-fill]
		events:
			selected(item): 
				orderItemDetails.update(item);
			add(value):
				this.list.clearSearch();
				this.add(value);
	#add:function(name)
		var newItem = { 
			key: new Date().toISOString(), 
			name: name,
			options: {} };
		var result = this.data.set(newItem.key, newItem)[newItem.key];
		this.list.select(result.key);
	#init:function
		this.list.header.node.style.display = 'none';
	#render:function 
		this.list.update(this.data);
		orderItemDetails.update(this.list.selected);

OrderItem[item tight]
	#price[right]
	#nameSpan[name]
	#note$(data.note)[italic whitespace-pre margin2]
	#init:function
		this.node.addEventListener('click', 
			() => { this.emit('selected', this.data); });
	#render:function()
		this.price.innerHTML = SV.formatCurrency(this.data.price);
		this.nameSpan.innerHTML = this.data.name;
		this.note.style.display	= this.data.note ? 'flex' : 'none';



OrderItemDetails[col wide]
	#header:SimpleHeader({ text: 'Order Item Details', close: true, del: true})
		events:
			close:
				this.close();
			delete:
				Modal.confirm('Delete?', this.data.name, () => {
					var ticket = this.data.parent.parent;
					ticket.orderItems.remove(this.data.key);
					hub.emit('ticketTotalsChanged', ticket);
					this.close();
				});
	#nameInput:Input({ prop: 'name', label: 'Name' })$(update=data)
	#noteInput:Input({ prop: 'note', label: 'Note', isTextArea: true })$(update=data)
	#quantityInput:Input({ prop: 'quantity', label: 'Quantity', number: true  })$(update=data)[number]
	#priceInput:Input({ prop: 'price', label: 'Price', number: true  })$(update=data)[number]
	#close:function
			this.update(null);
	#init:function
			this.render();
	#render:function
			this.node.style.display = this.data ? 'block' : 'none';
	
MenuCategories[col col-flex col-right]
	#list:SearchList({ ctor: 'MenuItemCategory', searchBox: true, sort: 'name', searchProp: 'name', clearBtn: true })[col-fill]
		events:
			selected(item): 
				menuItems.update(item.items);
			add(value):
				this.list.clearSearch();
				this.add(value);
	#init:function
		this.list.header.node.style.display = 'none';
		this.list.postFilter = (data) => {
			return SV.filterMap(data, item => !item.isDisabled);
		}
	#render:function 
		this.list.update(this.data);
		menuItems.update((this.list.selected || {}).items);

MenuItemCategory[item]
	#nameSpan$(data.name)[name]
	#init:function
		this.node.addEventListener('click', 
			() => { this.emit('selected', this.data); });


MenuItems[col col-flex col-right]
	#list:SearchList({ text: 'Items', ctor: 'MenuItem', searchBox: true, sort: 'name', searchProp: 'name', clearBtn: true })[col-fill]
		events:
			selected(item): 
				ticketDetails.add(item);
	#init:function
		this.list.postFilter = (data) => {
			return SV.filterMap(data, item => !item.isDisabled);
		}
	#render:function 
		this.list.update(this.data);

MenuItem[item]
	#price[right]
	#nameSpan$(data.name)[name]
	#init:function
		this.node.addEventListener('click', 
			() => { this.emit('selected', this.data); });
	#render:function()
		this.price.innerHTML = SV.formatCurrency(this.data.price);




</script>




<script>
"use strict"

window.Input = Input

SV.startReloader();

var sync = new SyncNodeSocket('/data', {});
window.membersSync = new SyncNodeSocket('/members', {});
window.recSettings = new LocalSyncNode('recSettings');	



SV.onLoad(() => { 

		importCode('components.html'); 
		parse(SV.id('view').innerHTML); 

		sync.on('updated', (data) => {
			console.log('data', data);
			var rec = data.reconciliations[window.recSettings.selectedRecKey];
			ticketList.update(rec.tickets);
			menuCategories.update(data.menu.categories);			
			header.update(rec);			
		});
		
		window.membersSync.on('updated', (data) => {
			var users = SV.filterMap(data, (member) => { return member.data.info.isStaff });
			ticketDetails.moreEdit.server.update(users);
			header.userSelect.update(users);
			header.userSelect.select(window.recSettings.currentUser);
		});

	
		window.recSettings.on('updated', (data) => {
			ticketList.userSelect.select(data.currentUser);
		});
});






class RecUtils {
	static getTicketTotals(ticket) {
		var totals = {
			food: 0,
			tax: 0,
			alcohol: 0,
			total: 0
		};

		SV.toArray(ticket.orderItems).forEach((item) => {
			var amount = item.price * item.quantity;
			if(item.taxType === 'Included') {
				totals.alcohol += amount;
			} else  {
				totals.food += amount;
			}
		});

		totals.tax = totals.food * 0.09;
		totals.total = totals.food + totals.tax + totals.alcohol;

		return totals;
	}
	static getRecTotals(rec) {
		var totals = { food: 0, tax: 0, alcohol: 0, total: 0 };
		var tickets = SV.toArray(rec.tickets).forEach((ticket) => {
			var ticketTotals = RecUtils.getTicketTotals(ticket);
			totals.food += ticketTotals.food;
			totals.tax += ticketTotals.tax;
			totals.alcohol += ticketTotals.alcohol;
			totals.total += ticketTotals.total;
		});
		return totals;
	}

}


</script>
</body>
</html>
