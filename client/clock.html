<html>
<head>
<link rel="import" id="components.html" href="components.html">
<link rel="stylesheet" type="text/css" href="/css/app.css">
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/bower_components/moment/moment.js"></script>
<script type="text/javascript" src="/SyncNode.js"></script>
<script type="text/javascript" src="/SyncNodeSocket.js"></script>
<script type="text/javascript" src="/SyncView.js"></script>
<script type="text/javascript" src="/parse.js"></script>

</head>
<body>


<script id="view" type="text/other">

#hub:Hub
#header:Header
#weeksList:WeeksList[col-flex]

Hub
	#init:function
		this.filter = {};
	#search:function(value)
		//this.filter.search = SV.normalize(value);
		//hub.emit('filterChanged', this.filter);
	#selectShift:function(weekKey, dayKey, shiftKey)	
		this.filter.selectedWeek = this.data ? this.data.schedules.weeks[weekKey] : null;
		this.filter.selectedDay = this.filter.selectedWeek ? this.filter.selectedWeek.days[dayKey] : null;
		this.filter.selectedShift = this.filter.selectedDay ? this.filter.selectedDay.shifts[shiftKey] : null;
		hub.emit('filterChanged', this.filter);
	#setUser:function(name)
		this.filter.user = name;
		hub.emit('filterChanged', this.filter); 
	#setUser2:function(name)
		this.filter.user2 = name;
		hub.emit('filterChanged', this.filter); 
	#userDataList:datalist
	#updateNameDataList:function(users)
		this.userDataList.innerHTML = '';
		SV.forEach(users, (user) => {
			var option = SV.el('option', { value: user.data.info.name, parent: this.userDataList });
		});
	#render:function	
		weeksList.update(this.data.schedules.weeks);
		this.selectShift((this.filter.selectedWeek || {}).key, (this.filter.selectedDay || {}).key, (this.filter.selectedShift || {}).key);	


Header[row row-flex dark]
	:style
		height: 56px;
	#title[margin1 row-nofill] 'Timeclock'
	#userSelect:input[row-nofill]
		attributes:
			list: userDataList;	
		style:
			width: 239px;
		events:
			input(e):
				hub.setUser(e.target.value);
	#init:function
	#render:function


WeeksList
	#list:List({ ctor: 'WeekDetails', sort: 'startDate' })$(update=data)
		
WeekDetails[col-flex]
	:style
		display: none;
		height: auto;
		width: 100%;
		background-color: #FFF;
	#header:SimpleHeader({ text: '', repeat: true, del: true })[light tight]
		events:
			repeat:
				this.duplicateWeek();
			delete:
				Modal.confirm('Delete?', '', () => {
					this.data.parent.remove(this.data.key);
				});
	#list:List({ ctor: 'Day', sort: 'startTime' })[row-flex]$(update=data.days)
	#addShift:function(day, sortOrder, shift, area, position, name)
		var shift = {
			key: SyncNode.guidShort(),
			sortOrder: sortOrder,
			shift: shift,
			area: area,
			position: position,
			name: name || '',
			note: ''
		};
		day.shifts.set(shift.key, shift);	
	#addDay:function
		var startDate = SV.getDayOfWeek(0, moment(this.data.startDate));
		var startDateStr = startDate.toISOString();
		SV.forEach(this.data.days, (day) => {
			if(day.startDate >= startDateStr) {
				startDate = moment(day.startDate).add(1, 'days');
				startDateStr = startDate.toISOString();
			}
		});
		var day = {
			key: SyncNode.guidShort(),
			startDate: startDateStr,
			name: '',
			shifts: {}
		};
		this.data.days.set(day.key, day);
		day = this.data.days[day.key];
		var sortOrder = 0;
		this.addShift(day, sortOrder++, 'Lunch', 'Kitchen', 'Grill', 'Matt');
		this.addShift(day, sortOrder++, 'Lunch', 'Kitchen', 'Fryer', 'Jeremy');
		this.addShift(day, sortOrder++, 'Lunch', 'Kitchen', 'Line', 'Sarah');
		this.addShift(day, sortOrder++, 'Lunch', 'Front', 'Server 1');
		this.addShift(day, sortOrder++, 'Lunch', 'Front', 'Server 2');
		this.addShift(day, sortOrder++, 'Dinner', 'Kitchen', 'Grill', 'Matt');
		this.addShift(day, sortOrder++, 'Dinner', 'Kitchen', 'Fryer', 'Jeremy');
		this.addShift(day, sortOrder++, 'Dinner', 'Kitchen', 'Line', 'Sarah');
		this.addShift(day, sortOrder++, 'Dinner', 'Kitchen', 'Dishes');
		this.addShift(day, sortOrder++, 'Dinner', 'Front', 'Server 1');
		this.addShift(day, sortOrder++, 'Dinner', 'Front', 'Server 2');
		this.addShift(day, sortOrder++, 'Dinner', 'Front', 'Runner');
		this.addShift(day, sortOrder++, 'Dinner', 'Front', 'Bartender');
	#duplicateWeek:function
		var week = ClockUtils.duplicateWeek(this.data); 
		this.data.parent.set(week.key, week);
	#render:function
		this.node.style.display = this.data ? 'flex' : 'none';
		if(!this.data) {
			return;
		}
		this.header.text.innerHTML = moment(this.data.startDate).format('MMM Do') + ' - ' + moment(this.data.startDate).add(6, 'days').format('MMM Do, YYYY');

Day[row-fill]
	:style
		border-right: 1px solid #000;
	:events
		click:
			//this.data.parent.remove(this.data.key);
	#header:SimpleHeader({ text: '', add: true})[tight]
		events:
			add:
				this.addShift();
	#list:List({ ctor: 'Shift', sort: 'sortOrder' })[list]$(update=data.shifts)
	#addShift:function
		var sortOrder = 0;
		SV.forEach(this.data.shifts, (shift) => { if (shift.sortOrder >= sortOrder) sortOrder = shift.sortOrder + 1; });
		var shift = {
			key: SyncNode.guidShort(),
			shift: 'Dinner',
			area: 'Kitchen',
			sortOrder: sortOrder,
			position: '',
			name: '',
			note: ''
		};
		this.data.shifts.set(shift.key, shift);
		shift = this.data.shifts[shift.key];
		var day = shift.parent.parent;
		var week = day.parent.parent;
		hub.selectShift(week.key, day.key, shift.key);
		window.shiftDetails.show();
	#render:function
		this.header.text.innerHTML = moment(this.data.startDate).format('M/D ddd') + ' ' + this.data.name;


Shift[item super-tight row row-flex]
	:style
		font-size: 12px;
		padding-left: 8px;
	:events
		click:
			var shift = this.data;
			var day = shift.parent.parent;
			var week = day.parent.parent;
			hub.selectShift(week.key, day.key, shift.key);
			window.shiftDetails.show();
		mouseover:
			this.mouseoverTimeout = setTimeout(() => {
				this.mouseoverTimeout = null;
				hub.setUser2(this.data.name);	
			}, 200);
		mouseout:
			if(this.mouseoverTimeout) {
				clearTimeout(this.mouseoverTimeout);
				this.mouseoverTimeout = null;
			} else {
				hub.setUser2('');	
			}
	#note[row-nofill]
		style:
			width: 5em;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
	#nameLabel[row-nofill]$(data.name)
		style:
			width: 5em;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
	#time[row-fill]
		style:
			width: 5em;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			text-align: right;
			padding-right: 8px;
	#updateFilter:function
		var name = hub.filter.user;
		var isSelected = name && SV.normalize(this.data.name).includes(SV.normalize(name));
		var name2 = hub.filter.user2;
		var isSelected2 = name2 && SV.normalize(this.data.name).includes(SV.normalize(name2));
		this.node.style.backgroundColor = 'transparent';
		if(isSelected || isSelected2) {
			if(isSelected) this.node.style.backgroundColor = '#FF0';
			if(isSelected2) this.node.style.backgroundColor = '#0F0';
		} else {
			this.node.style.backgroundColor = this.data.shift === 'Lunch' ? '#DDD' : '#FFF';
			this.node.style.color = this.data.area === 'Front' ? '#00F' : '#000';
			if(this.data.isDisabled) this.node.style.color = '#CCC';
		}
	#init:function
		hub.on('filterChanged', this.updateFilter);
	#render:function
		this.note.innerHTML = this.data.position + ' ' + this.data.note;
		var time = '';
		if(this.data.clockIn) time += moment(this.data.clockIn).format('h:mm') + '-';
		if(this.data.clockOut) time += moment(this.data.clockOut).format('h:mm');
		if(this.data.clockIn && this.data.clockOut) time += ' ' + SV.durationAsHours(this.data.clockIn, this.data.clockOut).toFixed(2);
		this.time.innerHTML = time;
		this.updateFilter();



ShiftDetails
	#header:SimpleHeader({ text: 'Shift Details', close: true, del: true})
		events:
			close:
				this.emit('close');
			delete:
				Modal.confirm('Delete?', '', () => {
					this.data.parent.remove(this.data.key);
					this.emit('close');
				});
	#nameInput:Input({ label: 'Name', prop: 'name', datalist: 'userDataList'  })$(update=data)
	#positionInput:Input({ label: 'Position', prop: 'position' })$(update=data)
	#noteInput:Input({ label: 'Note', prop: 'note', isTextArea: true })$(update=data)
	#disabled:ToggleButton({ prop: 'isDisabled', trueText: 'Disabled', falseText: 'Active' })$(update=data)
	#clockIn:LabeledValue({ label: 'Clock In', prop: 'clockIn', formatter: SV.formatTime})$(update=data)
	#clockOut:LabeledValue({ label: 'Clock Out', prop: 'clockOut', formatter: SV.formatTime})$(update=data)
	#clockInBtn[btn] 'Clock In'
		events:
			click:
				this.data.set('clockIn', new Date().toISOString());
				this.emit('close');
	#clockOutBtn[btn] 'Clock Out'
		events:
			click:
				this.data.set('clockOut', new Date().toISOString());
				this.emit('close');
	#show:function
		this.modal.show();
	#init:function
		this.modal = Modal.createModal(this);
		hub.on('filterChanged', () => { this.update(hub.filter.selectedShift); });
	#render:function
		if(!this.data) this.modal.hide();

		


</script>




<script>
"use strict"


SV.startReloader();

var sync = new SyncNodeSocket('/data', {});
window.membersSync = new SyncNodeSocket('/members', {});

SV.onLoad(() => { 
		importCode('components.html'); 
		parse(SV.id('view').innerHTML); 
		
		window.shiftDetails = buildComponent('ShiftDetails');
		
		window.membersSync.on('updated', (data) => {
			var users = SV.filterMap(data, (member) => { return member.data.info.isStaff });
			hub.updateNameDataList(users);
		});

		sync.on('updated', (data) => {
			console.log('data', data);
			if(!data.schedules) {
				data.set('schedules', {
					key: SyncNode.guidShort(),
					weeks: {}
				});
			}
			hub.update(data);
		});
});

class ClockUtils {
		static duplicateDay(day) {
			var copy = JSON.parse(JSON.stringify(day));
			copy.key = SyncNode.guidShort();
			SV.forEach(copy.shifts, (shift) => {
				shift.clockIn = null;
				shift.clockOut = null;
			});
			copy.startDate = moment(copy.startDate).add(1, 'days').toISOString();
			return copy;
		}
		static duplicateWeek(week) {
			var copy = JSON.parse(JSON.stringify(week));
			copy.key = SyncNode.guidShort();
			copy.startDate = moment(copy.startDate).add(1, 'weeks').toISOString();
			SV.forEach(copy.days, (day) => {
				day.startDate = moment(day.startDate).add(1, 'weeks').toISOString();
				SV.forEach(day.shifts, (shift) => {
					shift.clockIn = null;
					shift.clockOut = null;
					if(shift.area === 'Front') shift.name = '';
				});
			});
			return copy;
		}
}

</script>
</body>
</html>
