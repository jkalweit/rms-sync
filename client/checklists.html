<html>
<head>
<link rel="import" id="components.html" href="components.html">
<link rel="stylesheet" type="text/css" href="/css/app.css">
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/SyncNode.js"></script>
<script type="text/javascript" src="/SyncNodeSocket.js"></script>
<script type="text/javascript" src="/SyncView.js"></script>
<script type="text/javascript" src="/parse.js"></script>
</head>
<body>


<script id="view" type="text/other">

#hub:Hub
#header:Header
#checklists:Checklists[col]
#checklistDetails:ChecklistDetails[col]


Hub
	#init:function
		this.filter = {};
	#select:function(key)
		this.filter.selected = (this.data.checklists || {})[key];
		hub.emit('filterChanged');
	#render:function	
		if(this.filter.selected) {
			this.select(this.filter.selected.key);
		}


Header[row row-flex dark]
	:style
		height: 56px;
	#title[margin1 row-fill] 'Checklists'
	#init:function
	#render:function

Checklists[col col-left col-flex]
	#header:SearchHeader({ searchBox: true, addBtn: true })[col-nofill]
		events:
			add(value):
				this.header.clear();
				this.add(value);
	#list:List({ ctor: 'Checklist', sort: 'name' })[col-fill list scroll-y]
	#add:function(name)
		var name = name || '';
		name = name.trim();
		if(!name) return;
		var newItem = { 
			key: SyncNode.guidShort(), 
			addedAt: new Date().toISOString(), 
			name: name,
			isDisabled: false,
			items: {} };
		this.data.set(newItem.key, newItem);
		hub.select(newItem.key);
	#init:function
	#render:function 
		this.list.update(this.data);
		if(!this.test && SV.toArray(this.data)[0]) {
			this.test = true;
			hub.select((SV.toArray(this.data)[0] || {}).key);
		}
		

Checklist[item tight]
	:events
		click:
			hub.select(this.data.key);
	#nameSpan$(data.name)[name]
	#updateFilter:function
		this.node.classList.toggle('selected', (hub.filter.selected || {}).key === this.data.key);
	#init:function
		hub.on('filterChanged', () => this.updateFilter());
	#render:function
		this.updateFilter();
		this.node.style.color = this.data.isDisabled ? '#777' : '#000';


ChecklistDetails[col col-left col-flex wide]
	#header:SimpleHeader({ "text": "Details", "close": true, 'del': true})
		events:
			close:
				this.close();
			delete:
				Modal.confirm('Delete?', '', () => {
					this.data.parent.remove(this.data.key);
					this.close();
				});
	#nameInput:Input({ prop: 'name', label: 'Name' })$(update=data)
	#noteInput:Input({ prop: 'note', label: 'Note' })$(update=data)
	#disableToggle:ToggleButton({ prop: 'isDisabled', trueText: 'Disabled', falseText: 'Enabled' })$(update=data)
	#items:ChecklistItems
	#close:function
			//itemDetails.close();
			this.update(null);
	#updateFilter:function	
		this.node.classList.toggle('hide', !this.data);	
	#init:function
		this.updateFilter();
		hub.on('filterChanged', () => { this.update(hub.filter.selected); });
	#render:function
		this.updateFilter();
		if(this.data) this.items.update(this.data.items);

ChecklistItems[col-fill col-flex]
	#header:SearchHeader({ searchBox: true, addBtn: true })[col-nofill]
		events:
			add(value):
				this.header.clear();
				this.add(value);
	#list:List({ ctor: 'ChecklistItem', sort: 'name'})[col-fill list scroll-y]
	#add:function(name)
		var newItem = { 
			key: SyncNode.guidShort(),
			addedAt: new Date().toISOString(), 
			name: name
		};
		this.data.set(newItem.key, newItem);
		//hub.selectValue(newItem.key);
	#render:function 
		this.list.update(this.data);

ChecklistItem[item row row-flex]
	#nameInput:input[row-fill]
		events:
			change:
				this.data.set('name', this.nameInput.value);
	#noteInput:textarea[row-fill]
		events:
			change:
				this.data.set('note', this.noteInput.value);
	#remove[row-nofill touch material-icons] 'delete'
		events:
			click:
				this.data.parent.remove(this.data.key);
	#init:function
	#render:function
		this.nameInput.value = this.data.name;	
		this.noteInput.value = this.data.note || '';	

</script>




<script>
"use strict"

window.Input = Input

SV.startReloader();

var sync = new SyncNodeSocket('/data', {});


SV.onLoad(() => { 
		importCode('components.html'); 
		parse(SV.id('view').innerHTML); 

		sync.on('updated', (data) => {
			if(!data.checklists) {
				data.set('checklists', { 
				});
			} else { 
				console.log('checklists', data.checklists);
				hub.update(data);
				checklists.update(data.checklists);
			}
		});
});

</script>
</body>
</html>
