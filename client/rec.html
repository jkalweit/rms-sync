<html>
<head>
<link rel="stylesheet" type="text/css" href="/css/app.css">
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/bower_components/moment/moment.js"></script>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript" src="/SyncNode.js"></script>
<script type="text/javascript" src="/SyncNodeSocket.js"></script>
<script type="text/javascript" src="/SyncView.js"></script>
<script type="text/javascript" src="/parse.js"></script>
<link rel="import" id="components.html" href="/components.html">
<link rel="import" id="kitchenComponents.html" href="/kitchenComponents.html">
</head>
<body>

<script type="text/javascript">
  Stripe.setPublishableKey('pk_test_HgozEWRWusGTiLHoVNbIvAtW');
</script>

<script id="view" type="text/other">

#hub:RecHub
#menuHub:MenuHub
#header:Header
#ticketList:TicketListMain
#ticketDetails:TicketDetails[col]
#menuItems:MenuItems[col right]
#menuCategories:MenuCategories[col right]
#recDisable:Disable

MenuHub
	#init:function
		this.filter = {};
	#selectCategory:function(key)
		this.filter.selectedCategory = this.data.categories[key];
		this.emit('filterChanged', this.filter);
	#render:function	
		if(this.filter.selectedCategory) {
			this.selectCategory(this.filter.selectedCategory.key);
		}



DeleteOrderItem
	#header:SimpleHeader({ text: 'Delete Order Item', cancel: true })
	#note:Input({ label: 'Note' })
	#compNotServed[btn] 'Not Served'
		events:
			click:
				if(this.validate()) this.doDelete('Not Served');
	#compQuality[btn] 'Bad Quality/Service'
		events:
			click:
				if(this.validate()) this.doDelete('Bad Quality/Service');
	#cancel[btn] 'Cancel'
		events:
			click:
				this.itemToDelete = null;
				this.emit('close');
	#validate:function
		var isValid = this.note.input.value.trim() !== '';
		if(!isValid) {
			Modal.showNotification('Note is required');
		}
		return isValid;
	#delete:function(orderItem)
		this.itemToDelete = orderItem;
		if(!orderItem.submittedAt) {
			this.doDelete();
		} else {
			this.header.text.innerHTML = 'Delete Order Item: ' + orderItem.name + ' ' + SV.formatCurrency(RecUtils.getOrderItemTotal(orderItem))
			this.modal.show();
		}
	#doDelete:function(reason)
		if(reason) {
			var message = this.header.text.innerHTML + ': ' + reason + ': ' + this.note.value;
			SV.sendToAdmin(message);
		}
		var ticket = this.itemToDelete.parent.parent;
		ticket.orderItems.remove(this.itemToDelete.key);
		hub.emit('ticketTotalsChanged', ticket.key);
		this.itemToDelete = null;
		this.emit('close');
	#init:function
		this.modal = Modal.createModal(this);

AdminPin
	#title:h1 'Enter Admin Pin'
	#error:h3[hide] 'Incorrect, try again'
		style:
			color: #F00;
	#pin:Input({ label: 'Pin' })
	#submit[btn] 'Submit'
		events:
			click:
				this.doSubmit();
	#cancel[btn] 'Cancel'
		events:
			click:
				this.modal.hide();
	#doSubmit:function
		this.error.classList.add('hide');
		verifyAdminPin(this.pin.input.value, (result) => {
			this.pin.input.value = '';
			if(result) {
				if(this.callback) this.callback();
				this.callback = null;
				this.modal.hide();
			} else {
				this.error.classList.remove('hide');
			}
		});
	#verify:function(callback)
		this.error.classList.add('hide');
		this.pin.input.value = '';
		this.callback = callback;
		this.modal.show();
	#init:function
		this.pin.input.type = 'password';
		this.modal = Modal.createModal(this);
		this.modal.on('show', () => { this.pin.focus(); });

CreditCardDetails
	#title:h1 'Credit Card'
	#input:textarea[margin1]
		style:
			width: 100%;
			height: 50px;
	#submitBtn:div[btn] 'Submit'
		events:
			click:
				this.submit();
	#init:function
	#parseCC:function(str)
		var number = /%B(\d{16})\^/.exec(str)[1];
		var name = /\^(.*?)\^/.exec(str)[1];	
		var lastname = /(.*?)\//.exec(name)[1];	
		var firstname = /.*?\/(.*)/.exec(name)[1];	
		var exp_year = /\^.*?\^(\d{2})/.exec(str)[1];	
		var exp_month = /\^.*?\^\d{2}(\d{2})/.exec(str)[1];	
		var result = { firstname: firstname, lastname: lastname, 
						cc: { name: name, number: number, exp_month: exp_month, exp_year: exp_year }
					 };
		return result;
	
	#submit:function
		console.log('Submit!');
		var data = this.parseCC('%B4242424242424242^KALWEIT/JUSTIN ^1812');	
		Stripe.card.createToken(data.cc, (status, response) => {
			console.log('response:', status, response);
			if(response.error) {
				console.log('Error: ', response.error.message);
			} else {
				console.log('response:', status, response);
				var token = response.id;
				SV.chargeCreditCard({ token: token, amount: 1.00, memberId: 'jkalweit' });
			}
		});
		console.log('Submitted');

Disable[flex hide]
	:style
		position: absolute;
		justify-content: center;
		align-items: center;
		top: 56px;
		bottom: 0; left: 0; right: 0;
		z-index: 2;
		background-color: rgba(0,0,0,0.8);
	#message[shadow bold]
		style:
			padding: 2em;
			width: 50%;
			text-align: center;
			background-color: #FFF:
	#show:function(message)
		this.message.innerHTML = message;
		this.node.classList.toggle('hide', false);	
	#hide:function()
		this.node.classList.toggle('hide', true);	

RecList
	#header:SimpleHeader({ text: 'Select a Rec', add: true, close: true })
		events:
			add:
				this.addRec();
			close:
				window.selectRecModal.hide();
	#list:SimpleList({ ctor: 'Rec' })
		events:
			selected(rec):
				this.select(rec.key);
	#select:function(key)
		window.recSettings.set('selectedRecKey', key);
		this.emit('close');
	#addRec:function
		var added = new Date().toISOString();
		var now = moment();
		var name = moment(added).format('dddd MMM Do, YYYY') + ' - ' + (now.hour() < 13 ? 'Lunch' : 'Dinner');
		var newRec = {
			key: name,
			added: added,
			name: name,
			tickets: {},
			totals: { food: 0, tax: 0, alcohol: 0, total: 0 }
		};

		if(this.data[name]) {
			Modal.confirm('Duplicate Rec', 'There is already a rec named "' + name + '", are you sure you want to create another one?',
					() => {
						newRec.key += (' ' + now.format('h:mma'));
						newRec.name = newRec.key;
						this.data.set(newRec.key, newRec);
						this.select(newRec.key);
					});
		} else {
			this.data.set(newRec.key, newRec);
			this.select(newRec.key);
		}
	#init:function
		window.recSettings.on('updated', () => { 
		 	SV.forEach(this.list.list.views, (view) => view.render() ); 
		});
	#render:function
		this.list.update(this.data);
		
Rec[item tight]
	:events
		click:
			this.emit('selected', this.data);
	#nameSpan$(data.name)
	#render:function
		this.node.classList.toggle('selected', this.data.key === window.recSettings.selectedRecKey);


RecHub
	#init:function
		this.ticketFilter = { showPaid: false, selectedTicket: null };
		this.on('ticketTotalsChanged', (ticketKey) => {
			var ticket = this.data.tickets[ticketKey];
			if(ticket) ticket.merge({ totals: RecUtils.getTicketTotals(ticket) });
			this.data.merge({ totals: RecUtils.getRecTotals(this.data) });
		});
	#clearTicketSearch:function
		this.ticketFilter.name = '';
		this.fireTicketFilterChanged();
	#selectTicket:function(ticket)
		this.ticketFilter.selectedTicket = ticket;
		this.ticketFilter.selectedOrderItem = null;
		this.fireTicketFilterChanged();
	#selectOrderItem:function(orderItem)
		this.ticketFilter.selectedOrderItem = orderItem;
		this.fireTicketFilterChanged();
	#fireTicketFilterChanged:function
		hub.emit('ticketFilterChanged', this.ticketFilter);
	#moveOrderItem:function(oldTicketKey, orderItemKey, newTicketKey)
		var oldTicket = this.data.tickets[oldTicketKey];
		var newTicket = this.data.tickets[newTicketKey];
		if(RecUtils.isTicketPaid(newTicket) || oldTicket.key === newTicket.key) return;
		var orderItem = oldTicket.orderItems[orderItemKey];
		if(!orderItem) return;
		var mergeOldTicket = { orderItems: { __remove: orderItem.key } };
		var mergeNewTicket = { orderItems: {} };
		mergeNewTicket.orderItems[orderItem.key] = orderItem;
		var merge = {};
		merge[oldTicket.key] = mergeOldTicket;
		merge[newTicket.key] = mergeNewTicket;
		this.data.tickets.merge(merge);
		oldTicket = this.data.tickets[oldTicket.key];
		newTicket = this.data.tickets[newTicket.key];
		this.emit('ticketTotalsChanged', oldTicket.key);
		this.emit('ticketTotalsChanged', newTicket.key);
	#render:function	
		if(this.ticketFilter.selectedTicket) {
			var selectedOrderItem = this.ticketFilter.selectedOrderItem;
			this.selectTicket(this.data.tickets[this.ticketFilter.selectedTicket.key]);
			if(selectedOrderItem) {
				if(this.ticketFilter.selectedTicket) {
					this.selectOrderItem(this.ticketFilter.selectedTicket.orderItems[selectedOrderItem.key]);
				} else {
					this.selectOrderItem(null);
				}
			}
		}


KitchenOrderPreview[group]
	:h1 'Order Preview'
	#submittedAt:LabeledValue({ label: 'Submitted' });
	#order:KitchenOrder[margin1]
		style:
			margin-bottom: 1em;
	#updateSubmittedTime:function
		this.data.submittedAt = new Date().toISOString();
		this.render();
	#render:function
		this.submittedAt.value.innerHTML = moment(this.data.submittedAt).format('h:mma') + ' by ' + this.data.submittedBy;
		this.order.update(this.data);
		if(!this.submittedTimer) {
			this.submittedTimer = setInterval(() => { this.updateSubmittedTime(); }, 30000);
		}
		

TableSelect
	#header[header] 'Select a Table'
	#lists[group]
		style:
			border: 1px solid rgba(0,0,0,0.5);
	#closeBtn[btn group] 'Cancel'
		style:
			clear: both;
			margin-top: 2em;
		events:
			click:
				this.emit('close');
	#init:function
		var tables1 = ['1-1', '1-2', '1-3', '1-4', '1-5', '1-6', 'Bar'];
		var tables2 = ['2-1', '2-2', '2-3', '2-4', '2-5', 'Deck', 'Other'];
		this.list1 = SV.el('div', { parent: this.lists, className: 'col-left list',
			style: { width: '50%' }});
		tables1.forEach((table) => {
			var item = buildComponent('Table');
			item.on('selected', (name) => { this.emit('selected', name); });
			item.update({ name: table });
			this.list1.appendChild(item.node);
		});
		this.list2 = SV.el('div', { parent: this.lists, className: 'col-left list',
			style: { width: '50%' }});
		tables2.forEach((table) => {
			var item = buildComponent('Table');
			item.on('selected', (name) => { this.emit('selected', name); });
			item.update({ name: table });
			this.list2.appendChild(item.node);
		});

Table[item]
	:events
		click:
			this.emit('selected', this.data.name);
	#nameSpan$(data.name)


RecTotalsEdit
	#beginning:Input({ label: 'Beginning', prop: 'beginning', number: true })$(update=data)[number]
	#sales:LabeledValue({ label: 'Sales' })[number]
	#ending:Input({ label: 'Ending', prop: 'ending', number: true })$(update=data)[number]
	#credit:Input({ label: 'Credit, no tips', prop: 'Credit', number: true })$(update=data)[number]
	#creditTips:Input({ label: 'Credit Tips', prop: 'Credit Tips', number: true })$(update=data)[number]
	#giftCards:Input({ label: 'Gift Cards', prop: 'giftCards', number: true })$(update=data)[number]
	#payouts:Input({ label: 'Payouts', prop: 'Payouts', number: true })$(update=data)[number]
	#total:LabeledValue({ label: 'Total' })[number]
		style:
			font-weight: bold;
			font-size: 24px;
	#render:function
		if(this.data) {
			this.total.value.innerHTML = SV.formatCurrency(this.data.beginning);
			this.sales.value.innerHTML = SV.formatCurrency(this.data.parent.totals.total);
		}


RecSettings
	:h1 'Rec Settings'
	#totals:RecTotalsEdit
		style:
			width: 50%;
			float: left;
	#close[btn] 'Close'
		events:
			click:
				this.emit('close');
	#render:function
		this.totals.update(this.data)

RecTotals[header]
	:style
		margin-right: 16px;
	#total:div
		style:
			float: right;
	#render:function
		this.total.innerHTML = SV.formatCurrency(this.data.total);

Header[row row-flex black]
	:style
		height: 56px;
	#userSelect:Select({ prop: 'data.info.name', sort: 'data.info.name' })[row-nofill]
		style:
			width: 239px;
		events:
			selected(name):
				window.recSettings.set('currentUser', name);
	#title[row-nofill bold]
	#status[row-fill margin1 bold]
	#totals:RecTotals[row-nofill]
	:div[row-nofill touch material-icons] 'settings'
		events:
			click:
				this.recSettingsModal.show();
	:div[row-nofill touch material-icons] 'check'
		events:
			click:
				window.selectRecModal.show();
	#init:function
		this.recSettings = buildComponent('RecSettings');
		this.recSettingsModal = Modal.createModal(this.recSettings);
		sync.on('statusChanged', (path, status) => {
			if(status !== 'Connected') {
				this.node.classList.add('error');
				this.status.innerHTML = 'Warning: ' + status;
			} else {
				this.node.classList.remove('error');
				this.status.innerHTML = '';
			}
		});

	#render:function
		this.totals.update(this.data.totals);
		this.title.innerHTML = this.data.name;
		this.recSettings.update(this.data.drawer);
		

TicketListMain[col col-flex col-left]
	#ticketList:TicketList
		events: 
			selected(ticket):
				hub.selectTicket(ticket);
	#render:function
		this.ticketList.update(this.data);

TicketList[col-flex]
	#header:SearchHeader({ searchBox: true, addBtn: true })[col-nofill]
		events:
			add(value):
				this.clearSearch();
				this.add(value);
			searchChanged(value):
				this.search(value);
	#list:SimpleList({ ctor: 'TicketGroup' })[col-fill]
		events:
			selected(ticket):
				this.emit('selected', ticket);
	#clearSearch:function
		this.header.clear();
	#search:function(value)
		hub.ticketFilter.name = value;
		hub.emit('ticketFilterChanged', hub.ticketFilter);	
	#add:function(name)
		var name = name || '';
		name = name.trim();
		//if(!name) return;
		var newItem = { 
			key: SyncNode.guidShort(), 
			addedAt: new Date().toISOString(),
			addedBy: window.recSettings.currentUser,
			servedBy: window.recSettings.currentUser,
			name: name,
			table: '',
			isTogo: false,
			orderItems: {},
			paymentStatus: 'Unpaid',
			totals: { food: 0, tax: 0, alcohol: 0, total: 0 }
		};
		this.itemToAdd = newItem;
		this.tableSelectModal.show();
	#init:function
		this.showPaidBtn = SV.el('div', { className: 'touch material-icons col-nofill', innerHTML: 'payment',
			events: { click: () => { 
				hub.ticketFilter.showPaid = !hub.ticketFilter.showPaid;
				hub.emit('ticketFilterChanged', hub.ticketFilter); 
			}}});
		this.header.node.appendChild(this.showPaidBtn);
		this.tableSelect = buildComponent('TableSelect');
		this.tableSelect.on('selected', (table) => {
			this.tableSelectModal.hide();
			var newItem = this.itemToAdd;
			newItem.table = table;		
			var result = this.data.set(newItem.key, newItem)[newItem.key];
			hub.ticketFilter.selectedTicket = result;
			hub.emit('ticketFilterChanged', hub.ticketFilter);
		});
		this.tableSelectModal = Modal.createModal(this.tableSelect);
		hub.on('ticketFilterChanged', () => {
			this.showPaidBtn.classList.toggle('highlight', hub.ticketFilter.showPaid);
		});
	#sortGroups:function()
		// put the current server's tickets at the top
		var groups = SV.group(this.data, (item) => { return item.servedBy; });  
		var sorted = {};
		var server = window.recSettings.currentUser;
		if(groups[server]) {
			sorted[server] = groups[server];
		}

		Object.keys(groups).forEach((key) => {
			sorted[key] = groups[key];
		});
		this.list.update(sorted);
	#render:function 
		this.sortGroups();
		this.test = true;
		if(this.test) return;
		this.test = true;
		hub.ticketFilter.selectedTicket = SV.toArray(this.data)[0];
		hub.emit('ticketFilterChanged', hub.ticketFilter);
		ticketDetails.totals.sendToKitchen();

TicketGroup
	#server[bold light]
		style:
			padding: 8px 8px;
			color: rgba(0,0,0,0.5);
	#list:SimpleList({ ctor: 'Ticket', sort: 'addedAt', searchProp: 'name' })[col-fill]
		events:
			selected(ticket):
				this.emit('selected', ticket);
	#render:function
		this.server.innerHTML = this.data.key;
		this.list.update(this.data);
		
Ticket[item tight ticket]
	:events
		click:
			this.emit('selected', this.data);
		dragover(e):
			e.preventDefault();
			e.dataTransfer.dropEffect = 'move';
		drop(e):
			var data = JSON.parse(e.dataTransfer.getData('text/plain'));
			hub.moveOrderItem(data.ticketKey, data.orderItemKey, this.data.key);
			this.dragenterCount = 0;
			this.updateDragover();
		dragenter:
			if(!this.dragenterCount) this.dragenterCount = 0;
			this.dragenterCount++;
			this.updateDragover();
		dragleave:
			this.dragenterCount--;
			this.updateDragover();
	#updateDragover:function
		this.node.classList.toggle('glow', this.dragenterCount > 0);
	#total[right margin1]
	#nameSpan
	#lastOrderTime[italic margin1]
		style:
			color: rgba(0,0,0,0.5);
			display: none;
	#updateLastOrderTime:function
		this.lastOrderTime.innerHTML = RecUtils.getLastOrderTimeFriendly(this.data.orderItems);
	#init:function
		hub.on('ticketFilterChanged', () => { this.doFilter(); });
		hub.on('ticketTotalsChanged', () => { this.updateDisplay(); });
	#doFilter:function
		var hide = false;
		if(hub.ticketFilter.name) {
			hide = SV.normalize(this.data.table + ' ' + this.data.name).indexOf(SV.normalize(hub.ticketFilter.name)) === -1;	
		}
		hide = hide || (!hub.ticketFilter.showPaid && RecUtils.isTicketPaid(this.data));
		this.node.classList.toggle('hide', hide);	
		this.node.classList.toggle('dark', (hub.ticketFilter.selectedTicket || {}).key === this.data.key );	
	#updateDisplay:function
		var unsubmitted = RecUtils.getUnsubmittedTicketOrderItems(this.data);
		var hasUnsubmitted = !SV.isEmptyObject(unsubmitted.kitchen) || !SV.isEmptyObject(unsubmitted.bar);
		this.nameSpan.classList.toggle('highlight', hasUnsubmitted);
		this.nameSpan.classList.toggle('blink', hasUnsubmitted);
	#render:function
		this.total.innerHTML = SV.formatCurrency(this.data.totals.total);
		this.nameSpan.innerHTML = `<span style="display: inline-block; width: 3em;">${this.data.table}</span> <span style="font-weight: bold">${this.data.name}</span>`;
		if(this.data.isTogo) this.nameSpan.innerHTML += ' <span class="highlight">[TOGO]</span>';
		this.doFilter();
		this.updateDisplay();
		this.updateLastOrderTime();
		this.node.classList.toggle('disabled', RecUtils.isTicketPaid(this.data));
		if(!this.lastOrderTimeTimer) {
			this.lastOrderTimeTimer = setInterval(() => { this.updateLastOrderTime(); }, 30000);
		}


TicketTotals[header dark row-flex]
	:style
		//border-top: 1px solid rgba(0,0,0,0.5);
		padding-left: 0;
		font-size: 24px;
	#sendKitchen[touch material-icons row-nofill] 'local_dining'
		events:
			click:
				this.sendToKitchen();
	#sendBar[touch material-icons row-nofill] 'local_bar'
		events:
			click:
				this.sendToBar();
	#total:div[row-fill]
		style:
			text-align: right;
	#print[touch material-icons row-nofill] 'print'
		events:
			click:
				this.printReceipt();
	#payment[touch material-icons row-nofill]
		events:
			click:
				this.cyclePaymentStatus();
	#sendToKitchen:function
		var merge = {};
		var submittedAt = new Date().toISOString();
		var submittedBy = window.recSettings.currentUser;
		var ko = { 
					key: SyncNode.guidShort(),
					ticketKey: this.data.key,
					table: this.data.table,
					name: this.data.name,
					submittedAt: submittedAt, 
					submittedBy: submittedBy,
					completedAt: {},
					orderItems: {}
		};
		var unsubmitted = RecUtils.getUnsubmittedTicketOrderItems(this.data);
		SV.forEach(unsubmitted.kitchen, (item) => {
			merge[item.key] = { submittedAt: submittedAt, submittedBy: submittedBy  };	
			var orderItem = {
				key: item.key,
				name: item.name,
				quantity: item.quantity,
				note: item.note,
				options: JSON.parse(JSON.stringify(item.options))
			};
			ko.orderItems[orderItem.key] = orderItem;
		});
		if(SV.toArray(ko.orderItems).length === 0) return;
		this.kitchenOrderToSubmit = { order: ko, merge: merge };
		this.kitchenOrderPreview.update(ko);
		this.kitchenOrderPreviewModal.show();
	#sendToBar:function
		var merge = {};
		var submittedAt = new Date().toISOString();
		var submittedBy = window.recSettings.currentUser;
		var ko = { 
					key: SyncNode.guidShort(),
					ticketKey: this.data.key,
					table: this.data.table,
					name: this.data.name,
					submittedAt: submittedAt, 
					submittedBy: submittedBy,
					serveType: 'Bar',
					completedAt: {},
					orderItems: {}
		};
		var unsubmitted = RecUtils.getUnsubmittedTicketOrderItems(this.data);
		SV.forEach(unsubmitted.bar, (item) => {
			merge[item.key] = { submittedAt: submittedAt, submittedBy: submittedBy  };	
			var orderItem = {
				key: item.key,
				name: item.name,
				quantity: item.quantity,
				note: item.note
			};
			ko.orderItems[orderItem.key] = orderItem;
		});
		if(SV.toArray(ko.orderItems).length === 0) return;
		this.barOrderToSubmit = { order: ko, merge: merge };
		this.barOrderPreview.update(ko);
		this.barOrderPreviewModal.show();
	#cyclePaymentStatus:function
		var newStatus;
		switch(this.data.paymentStatus) {
			case 'Unpaid':
				newStatus = 'Credit Card';
				break;
			//case 'Credit Card':
			//	newStatus = 'Cash';
			//	break;
			default:
				newStatus = 'Unpaid';
		}
		this.data.set('paymentStatus', newStatus);
	#printReceipt:function
		SV.printReceipt(this.data);	
	#init:function
		this.kitchenOrderPreview = buildComponent('KitchenOrderPreview');
		this.kitchenOrderPreviewModal = Modal.createModal(this.kitchenOrderPreview);
		SV.el('div', { parent: this.kitchenOrderPreviewModal.mainView, className: 'btn blink', innerHTML: 'Submit Order',
			events: { click: () => { 
				this.kitchenOrderPreviewModal.hide(); 
				if(!sync.data.kitchen) { sync.data.set('kitchen', {}); }
				if(!sync.data.kitchen.orders) { sync.data.kitchen.set('orders', {}); }
				var order = this.kitchenOrderToSubmit.order;
				var merge = { orders: {}};
				merge.orders[order.key] = order;
				sync.data.kitchen.merge(merge);	
				this.data.orderItems.merge(this.kitchenOrderToSubmit.merge);
				SV.playKitchenBell();
				this.kitchenOrderToSubmit = null;
			}}});
		SV.el('div', { parent: this.kitchenOrderPreviewModal.mainView, className: 'btn', innerHTML: 'Cancel',
			events: { click: () => { 
				this.kitchenOrderToSubmit = null;
				this.kitchenOrderPreviewModal.hide(); }}});
		
		this.barOrderPreview = buildComponent('KitchenOrderPreview');
		this.barOrderPreviewModal = Modal.createModal(this.barOrderPreview);
		SV.el('div', { parent: this.barOrderPreviewModal.mainView, className: 'btn blink', innerHTML: 'Submit Bar Order',
			events: { click: () => { 
				this.barOrderPreviewModal.hide(); 
				if(!hub.data.bar) hub.data.set('bar', { orders: {} });
				var order = this.barOrderToSubmit.order;
				hub.data.bar.orders.set(order.key, order);	
				this.data.orderItems.merge(this.barOrderToSubmit.merge);
				this.barOrderToSubmit = null;
			}}});
		SV.el('div', { parent: this.barOrderPreviewModal.mainView, className: 'btn', innerHTML: 'Cancel',
			events: { click: () => { 
				this.barOrderToSubmit = null;
				this.barOrderPreviewModal.hide(); }}});
	#render:function
		this.total.innerHTML = SV.formatCurrency(this.data.totals.total);
		this.payment.classList.toggle('highlight', RecUtils.isTicketPaid(this.data));
		var icon;
		switch(this.data.paymentStatus) {
			case 'Cash':
				icon = 'local_atm';
				break;
			default:
				icon = 'credit_card';
		}
		this.payment.innerHTML = icon;
		var unsubmitted = RecUtils.getUnsubmittedTicketOrderItems(this.data);
		this.sendKitchen.classList.toggle('highlight', !SV.isEmptyObject(unsubmitted.kitchen));
		this.sendKitchen.classList.toggle('blink', !SV.isEmptyObject(unsubmitted.kitchen));
		this.sendBar.classList.toggle('highlight', !SV.isEmptyObject(unsubmitted.bar));
		this.sendBar.classList.toggle('blink', !SV.isEmptyObject(unsubmitted.bar));



TicketDetails[col col-flex wide shadow]
	:style
		display: none;
		margin: 1em;
		height: auto;
		min-height: 50%;
		max-height: calc(100% - 56px - 2em);
		border: 1px solid rgba(0,0,0,0.5);
	#disableScreen
		style:
			background-color: rgba(0,0,0,0.3);
			position: absolute;
			top: 0; bottom: 56px; left: 0; right: 0;
			z-index: 1;
	#header:SimpleHeader({ text: 'Ticket Details', more: true, del: true})[dark border-bottom tight]
		events:
			more:
				this.showMore = !this.showMore;
				this.render();
			delete:
				Modal.confirm('Delete?', this.data.name, () => {
					window.adminPin.verify(() => {
						var key = this.data.key;
						this.data.parent.remove(key);
						hub.ticketFilter.selectedTicket = null;
						hub.emit('ticketTotalsChanged', key);
						hub.emit('ticketFilterChanged');
						this.close();
					});
				});
	#details:TicketDetailsMore[col-nofill]
	#moreEdit:TicketDetailsMoreEdit[col-nofill light]
	#items:OrderItemList[col-fill]
		events:
			edit(orderItem):
				this.editOrderItem(orderItem);
	#totals:TicketTotals[col-nofill]
	#close:function
		this.update(null);
	#editOrderItem:function(orderItem)
		hub.selectOrderItem(orderItem);
		this.orderItemDetailsModal.show();	
		this.orderItemDetails.noteInput.focus();
	#add:function(menuItem)
		if(!this.data) {
			console.log('no ticket selected');
			return;
		}
		if(RecUtils.isTicketPaid(this.data)) {
			console.log('Ticket is already paid.');
			return;
		}
		var newItem = { 
			key: SyncNode.guidShort(),
			addedAt: new Date().toISOString(),
			addedBy: window.recSettings.currentUser,
			name: menuItem.name,
			price: menuItem.price,
			quantity: 1,
			isAlcohol: menuItem.isAlcohol,
			serveType: menuItem.serveType,
			taxType: menuItem.taxType,
			note: menuItem.note || '',
			options: {}
		};
		SV.forEach(menuItem.options, (option) => {
			var o = {
				key: SyncNode.guidShort(),
				name: option.name,
				categoryKey: option.categoryKey,
				value: '',
				price: 0,
				priceWithEntree: 0
			};
			newItem.options[o.key] = o;
		});
		this.orderItemToAdd = newItem;
		this.selectOptions();	
	#selectOptions:function
		if(!this.orderItemToAdd) return;
		var options = SV.toArray(this.orderItemToAdd.options);
		var optionToSelect;
		for(var i = 0; i < options.length; i++) {
			if(!options[i].value) {
				optionToSelect = options[i];
				break;
			}
		}	
		if(optionToSelect) {
			this.selectOptionsView.update(optionToSelect);
			this.selectOptionsViewModal.show();
		} else {
			//all options selected, add order item
			var newItem = this.orderItemToAdd;
			var result = ticketDetails.data.orderItems.set(newItem.key, newItem)[newItem.key];
			//ticketDetails.items.list.select(result.key);
			hub.emit('ticketTotalsChanged', this.data.key);
			this.editOrderItem(result);
		}
	#init:function
		hub.on('ticketFilterChanged', () => this.update(hub.ticketFilter.selectedTicket));
		this.orderItemDetails = buildComponent('OrderItemDetails');
		this.orderItemDetailsModal = Modal.createModal(this.orderItemDetails);
		this.selectOptionsView = buildComponent('SelectOptionsView');
		this.selectOptionsView.on('selected', (value) => { 
			var option = this.orderItemToAdd.options[this.selectOptionsView.data.key];
			if(option) {
				option.value = value.name;
				option.price = value.price;
				option.priceWithEntree = value.priceWithEntree;
			}
			this.selectOptionsViewModal.hide();
			this.selectOptions();
		});
		this.selectOptionsViewModal = Modal.createModal(this.selectOptionsView);
		SV.el('div', { parent: this.selectOptionsViewModal.mainView, innerHTML: 'Cancel', className: 'btn',
			style: { marginTop: '1em' },
			events: { click: () => { this.selectOptionsViewModal.hide(); }}});
	#render:function
		this.node.style.display = this.data ? 'flex' : 'none';
		if(!this.data) {
			return;
		}
		this.disableScreen.style.display = RecUtils.isTicketPaid(this.data) ? 'block' : 'none';
		this.details.node.style.display = this.showMore ? 'none' : 'block';
		this.moreEdit.node.style.display = this.showMore ? 'block' : 'none';
		if(this.data) { 
			this.header.text.innerHTML = `<span style="font-weight: normal; width: 3em; display: inline-block;">
											${this.data.table}</span> ${this.data.name}
											<br/><span class="small-text" style="font-weight: normal;"><span style="display: inline-block; width: 4.4em;">${ moment(this.data.addedAt).format('h:mma')}</span>${this.data.servedBy}</span>`;
			this.items.update(this.data.orderItems);
			this.details.update(this.data);
			this.moreEdit.update(this.data);
			this.moreEdit.server.select(this.data.servedBy);
			this.totals.update(this.data);
		}

SelectOptionsView[col-flex]
	#header:SimpleHeader({ text: 'Select Option' })
	#list:SimpleList({ ctor: 'MenuOption' })
		events:
			selected(value):
				this.emit('selected', value);
	#render:function
		var category = sync.data.menu.menuOptions.categories[this.data.categoryKey];
		if(!category) { console.log('Cannot find Category'); return; }
		this.header.setTitle(category.name);
		this.list.update(category.values);

MenuOption[item tight]
	:events
		click:
			this.emit('selected', this.data);
	#nameSpan$(data.name)
	

TicketDetailsMore[small-text]
	:style
		color: rgba(0,0,0,0.7);
		//border-bottom: 1px solid rgba(0,0,0,0.5);
	#lastServed[row tight margin1]
	#note$(data.note)[row tight margin2 italic whitespace-pre]
	#updateTime:function
		this.lastServed.innerHTML = 'Last order: ' + RecUtils.getLastOrderTimeFriendly(this.data.orderItems) + ' at ' + RecUtils.getLastOrderTime(this.data.orderItems); 
	#render:function
		this.note.style.display = this.data.note ? 'flex' : 'none';
		this.updateTime();
		if(!this.timer) {
			this.timer = setInterval(() => { this.updateTime(); }, 30000);
		}

TicketDetailsMoreEdit
	#addedBy[row tight small-text margin1]
	#table[btn]$(data.table)
		events:
			click:
				this.tableSelectModal.show();
	#togo:ToggleButton({ prop: 'isTogo', trueText: '**** TOGO ****', falseText: 'Eat In' })$(update=data)
	#nameInput:Input({ label: 'Name', prop: 'name'  })$(update=data)
	#noteInput:Input({ label: 'Note', prop: 'note', isTextArea: true })$(update=data)
	#server:Select({ label: 'Server', prop: 'data.info.name' })
		events:
			selected(value):
				this.data.set('servedBy', value); 	
	#updateTime:function
		this.addedBy.innerHTML = 'Added by ' + this.data.addedBy + ' ' + moment(this.data.addedAt).from(moment());
	#init:function
		this.tableSelect = buildComponent('TableSelect');
		this.tableSelect.on('selected', (table) => {
			this.tableSelectModal.hide();
			this.data.set('table', table);
		});
		this.tableSelectModal = Modal.createModal(this.tableSelect);
	#render:function
		this.togo.node.classList.toggle('warning', this.data.isTogo);
		this.updateTime();
		if(!this.timer) {
			this.timer = setInterval(() => { this.updateTime(); }, 30000);
		}

OrderItemList[col-flex]
	#list:List({ ctor: 'OrderItemGroup' })[col-fill list scroll-y]
		events:
			selected(item): 
				this.emit('selected', item);
	#init:function
		this.list.on('viewAdded', (view) => { view.on('edit', (orderItem) => { this.emit('edit', orderItem); }); });
	#render:function 
		var groups = SV.group(this.data, (item) => { 
			var diff = item.name + ' ' + item.note + ' ' + item.price;
			SV.forEach(item.options, (option) => { diff += ' ' + option.name + ' ' + option.value });
			return diff;
		});  
		this.list.update(groups);



OrderItemGroup[item tight]
	:style
		border: none;
	:events
		click(e):
			e.stopPropagation();
			this.showMore = !this.showMore;
			this.updateShowMore();
	#more[right tight touch material-icons] 'keyboard_arrow_down'
	#repeat[right tight touch material-icons] 'replay'
		events:
			click(e):
				e.stopPropagation();
				this.repeatItem();
	#price[right]
	#nameSpan
	#options[margin1 small-text]
	#note[margin1 italic small-text]
	#list:SearchList({ ctor: 'OrderItem' })
		style:
			display: none;
	#updateShowMore:function
		this.list.node.style.display = this.showMore ? 'flex' : 'none';
		this.more.innerHTML = this.showMore ? 'keyboard_arrow_up' : 'keyboard_arrow_down';
	#repeatItem:function
		var orderItem = this.model;
		var newItem = { 
			key: SyncNode.guidShort(),
			addedAt: new Date().toISOString(),
			addedBy: window.recSettings.currentUser,
			name: orderItem.name,
			price: orderItem.price,
			quantity: 1,
			isAlcohol: orderItem.isAlcohol,
			serveType: orderItem.serveType,
			taxType: orderItem.taxType,
			note: orderItem.note || '',
			options: JSON.parse(JSON.stringify(orderItem.options))
		};
		var ticket = this.model.parent.parent;
		var result = ticket.orderItems.set(newItem.key, newItem)[newItem.key];
		ticketDetails.items.list.select(result.key);
		hub.emit('ticketTotalsChanged', ticket.key);
	#init:function
		this.list.header.node.style.display = 'none';
		this.list.list.on('viewAdded', (view) => { view.on('edit', (item) => { this.emit('edit', item); }); });
		this.showMore = true;
	#render:function
		this.updateShowMore();
		var items = SV.toArray(this.data);
		var quantity = 0;
		var hasUnsubmitted = false;
		items.forEach((item) => {
			quantity += item.quantity
			if(!RecUtils.isOrderItemSubmitted(item)) hasUnsubmitted = true;
		});
		this.node.classList.toggle('highlight', hasUnsubmitted);
		this.model = items[0];
		this.nameSpan.innerHTML = this.model.name;
		var quantityText = quantity !== 1 ? quantity + ' x ' : '';	
		this.price.innerHTML = quantityText + SV.formatCurrency(this.model.price);
		var optionsText = '';
		SV.forEach(this.model.options, (option) => { optionsText += ' ' + option.value });
		this.options.innerHTML = optionsText;
		this.note.innerHTML = (this.model.note || '').replace('\n', ' - ');
		this.list.update(this.data);


OrderItem[row row-flex tight]
	:events
		click(e):
			e.stopPropagation();
			this.emit('edit', this.data);
		dragstart(e):
			var transfer = JSON.stringify({ ticketKey: this.data.parent.parent.key, orderItemKey: this.data.key });
			e.dataTransfer.dropEffect = 'move';
			e.dataTransfer.setData('text/plain', transfer);
	#move[margin1 tight touch material-icons] 'reorder'
		events:
			click(e):
				//e.stopPropagation();
	//#settings[right margin1 tight touch material-icons] 'settings'
	//	events:
	//		click(e):
	//			e.stopPropagation();
	//			this.emit('edit', this.data);
	#time[margin1 italic]
	#updateTime:function
		var quantity = `${this.data.quantity} @ `;
		this.time.innerHTML = quantity + moment(this.data.addedAt).from(moment());
	#init:function
		this.node.draggable = true;
	#render:function
		this.updateTime();
		if(!this.timer) { this.timer = setInterval(() => { this.updateTime(); }, 30000); }	
		var isSubmitted = RecUtils.isOrderItemSubmitted(this.data);
		this.node.classList.toggle('light-text', isSubmitted);

	


OrderItemDetails[col-flex]
	#header:SimpleHeader({ text: 'Order Item Details', close: true, del: true})
		events:
			close:
				this.emit('close');
			delete:
				window.deleteOrderItem.delete(this.data);
				this.emit('close');
	#nameInput:Input({ prop: 'name', label: 'Name' })$(update=data)
	#noteInput:Input({ prop: 'note', label: 'Note', isTextArea: true })$(update=data)
	#quantityInput:Input({ prop: 'quantity', label: 'Quantity', number: true  })$(update=data)[number]
		events:
			changed:
				hub.emit('ticketTotalsChanged', this.data.parent.parent.key);
	#priceInput:Input({ prop: 'price', label: 'Price', number: true  })$(update=data)[number]
		events:
			changed:
				hub.emit('ticketTotalsChanged', this.data.parent.parent.key);
	#options:SimpleList({ ctor: 'OrderItemDetailsOption' })
		style:
			margin-top: 2em;
		events:
			selected(option):
				this.selectOptionsView.update(option);
				this.selectOptionsViewModal.show();
	#init:function
		hub.on('ticketFilterChanged', () => this.update(hub.ticketFilter.selectedOrderItem));
		this.selectOptionsView = buildComponent('SelectOptionsView');
		this.selectOptionsView.on('selected', (value) => { 
			var option = this.selectOptionsView.data;
			if(option) {
				option.merge({ value: value.name, price: value.price, priceWithEntree: value.priceWithEntree });
			}
			this.selectOptionsViewModal.hide();
		});
		this.selectOptionsViewModal = Modal.createModal(this.selectOptionsView);
		this.selectOptionsViewModal.node.style.zIndex = 3;

		this.selectTicketList = buildComponent('TicketList');
		this.selectTicketList.header.addBtn.style.display = 'none';
		this.selectTicketList.showPaidBtn.style.display = 'none';
		this.selectTicketList.on('selected', (newTicket) => {
			var oldTicket = this.data.parent.parent;
			hub.moveOrderItem(oldTicket.key, this.data.key, newTicket.key);
			hub.clearTicketSearch();
			this.selectTicketListModal.hide();
			this.emit('close');
		});
		this.selectTicketListModal = Modal.createModal(this.selectTicketList);
		SV.el('div', { parent: this.selectTicketListModal.mainView, innerHTML: 'Cancel', className: 'btn',
			style: { marginTop: '1em' },
			events: { click: () => { this.selectTicketListModal.hide();  }}});
		this.selectTicketListModal.node.style.zIndex = 3;
		this.header.node.insertBefore(SV.el('div', { className: 'row-nofill touch material-icons', innerHTML: 'reply',
			events: { click: () => { 
				hub.clearTicketSearch();
				this.selectTicketListModal.show();
		}}}), this.header.close);
		this.render();
	#render:function
		this.node.classList.toggle('hide', !this.data);
		if(this.data) this.options.update(this.data.options);

OrderItemDetailsOption[item tight]
	:events
		click:
			this.emit('selected', this.data);
	#nameSpan
	#render:function
		this.nameSpan.innerHTML = this.data.name + ': ' + this.data.value;
	
MenuCategories[col col-flex col-right]
	#list:SearchList({ ctor: 'MenuCategory', searchBox: true, sort: 'name', searchProp: 'name', clearBtn: true })[col-fill]
		events:
			selected(item): 
				menuHub.selectCategory(item.key);
				//menuItems.update(item.items);
	#init:function
		this.list.header.node.style.display = 'none';
		//this.list.postFilter = (data) => {
		//	return SV.filterMap(data, item => !item.isDisabled);
		//}
		
	#render:function 
		this.list.update(this.data);
		//menuItems.update((this.list.selected || {}).items);

MenuCategory[item tight]
	:events
		click:
			menuHub.selectCategory(this.data.key);
	#nameSpan$(data.name)[name]
	#updateFilter:function
		this.node.classList.toggle('selected', this.data.key === (menuHub.filter.selectedCategory || {}).key);
		this.node.classList.toggle('hide', this.data.isDisabled);
	#init:function
		menuHub.on('filterChanged', () => this.updateFilter() );
	#render:function
		this.updateFilter();


MenuItems[col col-flex col-right]
	#header:SearchHeader({ searchBox: true, clearBtn: true })[col-nofill]
	#list:List({ ctor: 'MenuItem', sort: 'name' })[col-fill list scroll-y]
	#updateFilter:function
		this.list.update((menuHub.filter.selectedCategory || {}).items);
	#init:function
		menuHub.on('filterChanged', () => this.updateFilter() );
	#render:function 
		this.updateFilter();

MenuItem[item tight]
	:events
		click:
			ticketDetails.add(this.data);
	#price[right margin1]
	#nameSpan$(data.name)[name]
	#render:function()
		this.node.classList.toggle('hide', this.data.isDisabled);
		this.price.innerHTML = SV.formatCurrency(this.data.price);




</script>




<script>
"use strict"

window.Input = Input

SV.startReloader();


var sync = new SyncNodeSocket('/data', {});
window.membersSync = new SyncNodeSocket('/members', {});
window.recSettings = new LocalSyncNode('recSettings');	

var pinRequests = {};

function verifyAdminPin(pin, callback) {
	var request = {
		key: SyncNode.guidShort(),
		callback: callback
	};
	pinRequests[request.key] = request;
	io().emit('verify admin pin', pin, request.key);
}
io().on('verify admin pin result', (key, result) => {
	var request = pinRequests[key];
	if(!request) return;
	delete pinRequests[key];
	if(request.callback) {
		request.callback(result);
	}
});

SV.onLoad(() => { 

		importCode('components.html'); 
		importCode('kitchenComponents.html'); 
		parse(SV.id('view').innerHTML); 

		var recList = buildComponent('RecList');
		window.selectRecModal = Modal.createModal(recList);
		
		var creditCardDetails = buildComponent('CreditCardDetails');
		window.creditCardDetailsModal = Modal.createModal(creditCardDetails);
		window.creditCardDetailsModal.on('show', () => { creditCardDetails.input.focus(); });
		//window.creditCardDetailsModal.show();
		
		window.adminPin = buildComponent('AdminPin');
		window.deleteOrderItem = buildComponent('DeleteOrderItem');

		function updateRec() {
			var rec = sync.data.reconciliations[window.recSettings.selectedRecKey];
			hub.update(rec);
			header.update(rec);			
			if(!rec) {
				recDisable.show('Select a Rec');
			} else if(!window.recSettings.currentUser) {
				recDisable.show('Select a User');
			} else {
				recDisable.hide();
			}
			ticketList.node.classList.toggle('hide', !rec);
			if(rec) {
				ticketList.update(rec.tickets);
				ticketDetails.orderItemDetails.selectTicketList.update(rec.tickets);
			}
		}

		sync.on('updated', (data) => {
			console.log('data', data);
			menuHub.update(data.menu);
			recList.update(data.reconciliations);
			updateRec();
			menuCategories.update(sync.data.menu.categories);			
		});
		
		window.membersSync.on('updated', (data) => {
			var users = SV.filterMap(data, (member) => { return member.data.info.isStaff });
			ticketDetails.moreEdit.server.update(users);
			header.userSelect.update(users);
			header.userSelect.select(window.recSettings.currentUser);
		});

	
		window.recSettings.on('updated', (data) => {
			header.userSelect.select(data.currentUser);
			ticketList.ticketList.sortGroups();	
			updateRec();
		});
});






class RecUtils {
	static getOrderItemTotal(orderItem) {
		return orderItem.quantity * orderItem.price;
	}
	static getLastOrderItem(orderItems) {
		var lastOrderItem;
		SV.toArray(orderItems).forEach((orderItem) => {
			if(!lastOrderItem || orderItem.addedAt > lastOrderItem.addedAt) {
				lastOrderItem = orderItem;
			}
		});
		return lastOrderItem;
	}

	static getLastOrderTime(orderItems) {
		var lastOrderItem = RecUtils.getLastOrderItem(orderItems);
		return lastOrderItem ? moment(lastOrderItem.addedAt).format('h:mma') : '';
	}
	static getLastOrderTimeFriendly(orderItems) {
		var lastOrderItem = RecUtils.getLastOrderItem(orderItems);
		return lastOrderItem ? moment(lastOrderItem.addedAt).from(moment()) : 'no orders';
	}
	static isOrderItemSubmitted(item) { return item.submittedAt || item.serveType === 'Server'; }
	static isTicketPaid(ticket) { return ticket.paymentStatus !== 'Unpaid'; };
	static getTicketTotals(ticket) {
		var totals = {
			food: 0,
			tax: 0,
			alcohol: 0,
			total: 0
		};

		SV.toArray(ticket.orderItems).forEach((item) => {
			var amount = item.price * item.quantity;
			if(item.taxType === 'Included') {
				totals.alcohol += amount;
			} else  {
				totals.food += amount;
			}
		});

		totals.tax = parseFloat((totals.food * 0.09).toPrecision(2));
		totals.total = totals.food + totals.tax + totals.alcohol;

		return totals;
	}
	static getUnsubmittedTicketOrderItems(ticket) {
		var unsubmittedKitchen = {};
		var unsubmittedBar = {};
		SV.toArray(ticket.orderItems).forEach((item) => { 
			if(!RecUtils.isOrderItemSubmitted(item)) {
				if(item.serveType === 'Bar') unsubmittedBar[item.key]  = item; 
				else if(item.serveType === 'Kitchen') unsubmittedKitchen[item.key]  = item; 
			}
		});
		return { kitchen: unsubmittedKitchen, bar: unsubmittedBar };
	}
	static getRecTotals(rec) {
		var totals = { food: 0, tax: 0, alcohol: 0, total: 0 };
		var tickets = SV.toArray(rec.tickets).forEach((ticket) => {
			var ticketTotals = RecUtils.getTicketTotals(ticket);
			totals.food += ticketTotals.food;
			totals.tax += ticketTotals.tax;
			totals.alcohol += ticketTotals.alcohol;
			totals.total += ticketTotals.total;
		});
		return totals;
	}

}


</script>
</body>
</html>
